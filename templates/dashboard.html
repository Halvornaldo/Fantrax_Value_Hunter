<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantrax Value Hunter - V2.0 Enhanced - Cache Bust 2025-08-22-213500</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Left Panel: Parameter Controls -->
        <div class="left-panel">
            <!-- Header -->
            <div class="panel-header">
                <h2>Parameter Controls</h2>
            </div>

            <!-- Formula Version Selection -->
            <div class="parameter-group formula-version-section">
                <div class="group-header">
                    <span class="version-badge">V2.0</span>
                    <h3>Formula Version</h3>
                </div>
                <div class="version-toggles">
                    <label class="version-toggle">
                        <input type="radio" name="formula-version" value="v1" id="v1Toggle">
                        <span class="toggle-btn">v1.0 Legacy</span>
                    </label>
                    <label class="version-toggle active">
                        <input type="radio" name="formula-version" value="v2" id="v2Toggle" checked>
                        <span class="toggle-btn">v2.0 Enhanced</span>
                    </label>
                </div>
                <div class="version-features">
                    <div class="feature-item enabled">
                        <span class="checkmark">‚úì</span>
                        <span>Separated True Value & ROI</span>
                    </div>
                    <div class="feature-item enabled">
                        <span class="checkmark">‚úì</span>
                        <span>EWMA Form (Œ±=0.87)</span>
                    </div>
                    <div class="feature-item enabled">
                        <span class="checkmark">‚úì</span>
                        <span>Dynamic Blending</span>
                    </div>
                    <div class="feature-item enabled">
                        <span class="checkmark">‚úì</span>
                        <span>Normalized xGI</span>
                    </div>
                    <div class="feature-item enabled">
                        <span class="checkmark">‚úì</span>
                        <span>Exponential Fixtures</span>
                    </div>
                </div>
                <div class="version-description">
                    <em>v2.0 provides research-validated calculations with 10-15% better accuracy</em>
                </div>
            </div>

            <!-- Model Validation Status -->
            <div class="parameter-group model-validation">
                <div class="group-header">
                    <span class="status-indicator not-available" id="validationStatus">Not Available</span>
                    <h3>Model Validation Status</h3>
                </div>
                <div class="validation-metrics">
                    <div class="metric-box">
                        <div class="metric-label">RMSE:</div>
                        <div class="metric-value" id="rmse-value">--</div>
                        <div class="metric-status" id="rmse-status">üìä</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Correlation:</div>
                        <div class="metric-value" id="correlation-value">--</div>
                        <div class="metric-status" id="correlation-status">üìä</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Precision@20:</div>
                        <div class="metric-value" id="precision-value">--</div>
                        <div class="metric-status" id="precision-status">üìä</div>
                    </div>
                </div>
                <div class="validation-actions">
                    <button id="runValidation" class="btn btn-primary btn-full">üèÉ Run Validation</button>
                    <button id="viewResults" class="btn btn-secondary btn-full">üìä View Results</button>
                </div>
                <div class="validation-info">
                    <div class="last-validation">Last validation: <span id="lastValidation">Not run</span></div>
                    <div class="validation-help">Run validation to assess model quality and performance metrics.</div>
                </div>
            </div>

            <!-- EWMA Form Calculation -->
            <div class="parameter-group ewma-section">
                <div class="group-header">
                    <h3>EWMA Form Calculation</h3>
                </div>
                <div class="parameter-content">
                    <div class="slider-container">
                        <label for="ewmaAlpha">EWMA Alpha (Œ±):</label>
                        <div class="slider-wrapper">
                            <input type="range" id="ewmaAlpha" min="0.1" max="1.0" step="0.01" value="0.87">
                            <span class="slider-value" id="ewmaAlphaValue">0.87</span>
                        </div>
                    </div>
                    <div class="ewma-info">
                        <div class="info-row">
                            <span class="info-label">Half-life:</span>
                            <span class="info-value" id="halfLife">~0.3 games</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Recent Game Weight:</span>
                            <span class="info-value" id="recentWeight">87%</span>
                        </div>
                    </div>
                    <div class="ewma-help">
                        <small>v2.5 Enhancement: Exponential weighting gives more importance to recent performances, with Œ±=0.87 meaning recent games carry 87% weight vs. older games.</small>
                    </div>
                </div>
            </div>

            <!-- Dynamic Blending -->
            <div class="parameter-group blending-section">
                <div class="group-header">
                    <h3>Dynamic Blending</h3>
                </div>
                <div class="parameter-content">
                    <div class="slider-container">
                        <label for="adaptationGameweek">Adaptation Gameweek (K):</label>
                        <div class="slider-wrapper">
                            <input type="range" id="adaptationGameweek" min="8" max="20" step="1" value="16">
                            <span class="slider-value" id="adaptationGameweekValue">16</span>
                        </div>
                    </div>
                    <div class="blending-visualization">
                        <div class="blend-display">
                            <div class="blend-bar">
                                <div class="historical-portion" id="historicalPortion" style="width: 80%">
                                    <span class="portion-label">Historical 38+2</span>
                                </div>
                                <div class="current-portion" id="currentPortion" style="width: 20%">
                                    <span class="portion-label">Current 8</span>
                                </div>
                            </div>
                        </div>
                        <div class="blend-info">
                            <div class="info-row">
                                <span class="info-label">Current formula:</span>
                                <span class="info-value" id="blendFormula">w = min(1, (N-1)/(K-1))</span>
                            </div>
                        </div>
                    </div>
                    <div class="blending-help">
                        <small>v2.5 Enhancement: Exponential blending from historical (38+X) games to current season data, ensuring smooth transition as season progresses.</small>
                    </div>
                </div>
            </div>

            <!-- Normalized xGI -->
            <div class="parameter-group xgi-section">
                <div class="group-header">
                    <h3>Normalized xGI</h3>
                </div>
                <div class="parameter-content">
                    <div class="toggle-container">
                        <label class="toggle-switch">
                            <input type="checkbox" id="xgiEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Enable xGI Calculations</span>
                    </div>
                    <div class="xgi-controls" id="xgiControls" style="display: none;">
                        <div class="slider-container">
                            <label for="xgiStrength">Normalization Strength:</label>
                            <div class="slider-wrapper">
                                <input type="range" id="xgiStrength" min="0.5" max="2.0" step="0.1" value="1.0">
                                <span class="slider-value" id="xgiStrengthValue">1.0</span>
                            </div>
                        </div>
                        <div class="xgi-info">
                            <div class="info-row">
                                <span class="info-label">Position Adjustments:</span>
                                <span class="info-value">Defenders, Midfielders, Forwards</span>
                            </div>
                        </div>
                    </div>
                    <div class="xgi-help">
                        <small>v2.5 Enhancement: Normalized Expected Goals Involvement using 2024-25 baseline data for position-specific comparisons.</small>
                    </div>
                </div>
            </div>

            <!-- Multiplier Caps -->
            <div class="parameter-group caps-section">
                <div class="group-header">
                    <h3>Multiplier Caps</h3>
                </div>
                <div class="parameter-content">
                    <div class="caps-grid">
                        <div class="cap-item">
                            <label for="formCap">Form Cap:</label>
                            <div class="slider-wrapper">
                                <input type="range" id="formCap" min="1.5" max="3.0" step="0.1" value="2.0">
                                <span class="slider-value" id="formCapValue">2.0</span>
                            </div>
                        </div>
                        <div class="cap-item">
                            <label for="fixtureCap">Fixture Cap:</label>
                            <div class="slider-wrapper">
                                <input type="range" id="fixtureCap" min="1.3" max="2.5" step="0.1" value="1.8">
                                <span class="slider-value" id="fixtureCapValue">1.8</span>
                            </div>
                        </div>
                        <div class="cap-item">
                            <label for="xgiCap">xGI Cap:</label>
                            <div class="slider-wrapper">
                                <input type="range" id="xgiCap" min="2.0" max="4.0" step="0.1" value="2.5">
                                <span class="slider-value" id="xgiCapValue">2.5</span>
                            </div>
                        </div>
                        <div class="cap-item">
                            <label for="globalCap">Global Cap:</label>
                            <div class="slider-wrapper">
                                <input type="range" id="globalCap" min="2.5" max="5.0" step="0.1" value="3.0">
                                <span class="slider-value" id="globalCapValue">3.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="caps-info">
                        <div class="info-row">
                            <span class="info-label">Applied Caps:</span>
                            <span class="info-value" id="appliedCaps">Form: 2.0x | Fixture: 1.8x | xGI: 2.5x | Global: 3.0x</span>
                        </div>
                    </div>
                    <div class="caps-help">
                        <small>v2.5 Enhancement: Individual and global multiplier caps prevent extreme outliers while maintaining meaningful differentiation.</small>
                    </div>
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="applyChanges" class="btn btn-primary btn-large">Apply Changes</button>
                <div class="secondary-actions">
                    <button id="syncUnderstat" class="btn btn-secondary">Sync Understat Data</button>
                    <button id="importLineup" class="btn btn-secondary">Import Lineup</button>
                    <a href="/form-upload" class="btn btn-link">Upload Weekly Game Data</a>
                    <a href="/odds-upload" class="btn btn-link">Upload Odds</a>
                </div>
            </div>
        </div>

        <!-- Right Panel: Player Table -->
        <div class="right-panel">
            <!-- Header -->
            <div class="panel-header">
                <h2>All 633 Premier League Players</h2>
                <!-- Gameweek Status Indicator -->
                <div class="gameweek-status" id="gameweekStatus">
                    <div class="status-badge">
                        <span class="status-icon">üéØ</span>
                        <span class="status-text">Loading gameweek...</span>
                    </div>
                    <div class="data-freshness">
                        <span class="freshness-text">Last updated: Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Filters and Controls -->
            <div class="table-controls">
                <div class="filters-row">
                    <!-- Position Filter -->
                    <div class="filter-group">
                        <label>Position:</label>
                        <div class="position-buttons">
                            <button class="position-btn active" data-position="all">All</button>
                            <button class="position-btn" data-position="G">G</button>
                            <button class="position-btn" data-position="D">D</button>
                            <button class="position-btn" data-position="M">M</button>
                            <button class="position-btn" data-position="F">F</button>
                        </div>
                    </div>

                    <!-- Price Filter -->
                    <div class="filter-group">
                        <label>Price Range:</label>
                        <input type="number" id="priceMin" placeholder="4.0" step="0.5" value="4.0" style="width: 60px;">
                        <span>to</span>
                        <input type="number" id="priceMax" placeholder="15.0" step="0.5" value="15.0" style="width: 60px;">
                    </div>

                    <!-- Team Filter -->
                    <div class="filter-group">
                        <label>Team:</label>
                        <select id="teamFilter" style="width: 120px;">
                            <option value="all">All Teams</option>
                        </select>
                    </div>

                    <!-- Search -->
                    <div class="filter-group">
                        <label>Search Player:</label>
                        <input type="text" id="playerSearch" placeholder="Enter player name..." style="width: 150px;">
                    </div>
                </div>

                <div class="controls-row">
                    <div class="pagination-controls">
                        <span>Showing <span id="playerCount">100</span> players</span>
                        <select id="pageSize">
                            <option value="50">50 per page</option>
                            <option value="100" selected>100 per page</option>
                            <option value="200">200 per page</option>
                            <option value="all">All</option>
                        </select>
                    </div>
                    <button id="exportCSV" class="btn btn-secondary">Export CSV</button>
                </div>
            </div>

            <!-- Player Table -->
            <div class="table-container">
                <table id="playersTable" class="players-table">
                    <thead>
                        <tr>
                            <th data-sort="name" class="sortable">Name ‚Üï</th>
                            <th data-sort="team" class="sortable">Team ‚Üï</th>
                            <th data-sort="position" class="sortable">Pos ‚Üï</th>
                            <th data-sort="price" class="sortable">Price ‚Üï</th>
                            <th data-sort="ppg" class="sortable">PPG ‚Üï</th>
                            <th data-sort="pps" class="sortable">PPS ‚Üï</th>
                            <th data-sort="games" class="sortable">Games ‚Üï</th>
                            <th data-sort="true_value" class="sortable highlight-column">True Value ‚Üï</th>
                            <th data-sort="roi" class="sortable highlight-column">ROI ‚Üï</th>
                            <th data-sort="form" class="sortable">Form ‚Üï</th>
                            <th data-sort="fixture" class="sortable">Fixture ‚Üï</th>
                            <th data-sort="starter" class="sortable">Starter ‚Üï</th>
                            <th data-sort="xgi" class="sortable">xGI ‚Üï</th>
                            <th data-sort="starter_override" class="sortable">Starter Override ‚Üï</th>
                            <th data-sort="xgi90" class="sortable">xGI90 ‚Üï</th>
                            <th data-sort="xgi90_h" class="sortable">xGI90_H ‚Üï</th>
                            <th data-sort="min" class="sortable">Min ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="playersTableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <button id="prevPage" class="btn btn-secondary">Previous</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button id="nextPage" class="btn btn-secondary">Next</button>
            </div>
        </div>
    </div>

    <!-- Load JavaScript -->
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>