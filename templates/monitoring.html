<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Name Matching System Monitoring</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .refresh-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background-color: #45a049;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .health-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .health-good { background-color: #4CAF50; color: white; }
        .health-warning { background-color: #FF9800; color: white; }
        .health-bad { background-color: #f44336; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Name Matching System Monitoring</h1>
            <button class="refresh-btn" onclick="loadMetrics()">Refresh Data</button>
            <p id="lastUpdated" class="metric-label"></p>
        </div>

        <div id="loading" class="loading" style="display: none;">Loading monitoring data...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <!-- Overall Stats -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">Total Mappings</div>
                    <div class="metric-value" id="totalMappings">-</div>
                    <div class="metric-label">Player name mappings</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Match Rate</div>
                    <div class="metric-value" id="verificationRate">-</div>
                    <div class="metric-label">Verified mappings</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Avg Confidence</div>
                    <div class="metric-value" id="avgConfidence">-</div>
                    <div class="metric-label">Overall accuracy</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Source Systems</div>
                    <div class="metric-value" id="sourceSystems">-</div>
                    <div class="metric-label">Connected sources</div>
                </div>
            </div>

            <!-- Source System Breakdown -->
            <div class="table-container">
                <div class="metric-title">Source System Performance</div>
                <table>
                    <thead>
                        <tr>
                            <th>Source System</th>
                            <th>Total Mappings</th>
                            <th>Verified</th>
                            <th>Avg Confidence</th>
                            <th>Usage Count</th>
                            <th>Health</th>
                        </tr>
                    </thead>
                    <tbody id="sourceSystemTable">
                    </tbody>
                </table>
            </div>

            <!-- Confidence Distribution -->
            <div class="table-container">
                <div class="metric-title">Confidence Distribution</div>
                <table>
                    <thead>
                        <tr>
                            <th>Confidence Range</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="confidenceTable">
                    </tbody>
                </table>
            </div>

            <!-- Top Performers -->
            <div class="table-container">
                <div class="metric-title">Top Performing Mappings</div>
                <table>
                    <thead>
                        <tr>
                            <th>Source Name</th>
                            <th>Fantrax Name</th>
                            <th>Source System</th>
                            <th>Usage Count</th>
                            <th>Confidence</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="topPerformersTable">
                    </tbody>
                </table>
            </div>

            <!-- Problem Mappings -->
            <div class="table-container">
                <div class="metric-title">Mappings Needing Review</div>
                <table>
                    <thead>
                        <tr>
                            <th>Source Name</th>
                            <th>Fantrax Name</th>
                            <th>Source System</th>
                            <th>Confidence</th>
                            <th>Usage Count</th>
                        </tr>
                    </thead>
                    <tbody id="problemMappingsTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function loadMetrics() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            fetch('/api/monitoring/metrics')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    displayMetrics(data);
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = 'Error loading metrics: ' + error.message;
                });
        }

        function displayMetrics(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            // Update timestamp
            document.getElementById('lastUpdated').textContent = 
                'Last updated: ' + new Date(data.timestamp * 1000).toLocaleString();

            // Update overall stats
            document.getElementById('totalMappings').textContent = data.overall_stats.total_mappings || 0;
            document.getElementById('verificationRate').textContent = 
                (data.overall_stats.verification_rate || 0).toFixed(1) + '%';
            document.getElementById('avgConfidence').textContent = 
                (data.health_indicators.avg_confidence || 0).toFixed(1) + '%';
            document.getElementById('sourceSystems').textContent = data.overall_stats.source_systems || 0;

            // Update source system table
            const sourceSystemTable = document.getElementById('sourceSystemTable');
            sourceSystemTable.innerHTML = '';
            data.source_system_breakdown.forEach(system => {
                const row = sourceSystemTable.insertRow();
                row.innerHTML = `
                    <td>${system.source_system}</td>
                    <td>${system.total_mappings}</td>
                    <td>${system.verified}</td>
                    <td>${(system.avg_confidence || 0).toFixed(1)}%</td>
                    <td>${system.usage_count}</td>
                    <td>${getHealthIndicator(system.avg_confidence)}</td>
                `;
            });

            // Update confidence distribution
            const confidenceTable = document.getElementById('confidenceTable');
            confidenceTable.innerHTML = '';
            const totalMappings = data.overall_stats.total_mappings || 1;
            data.confidence_distribution.forEach(range => {
                const row = confidenceTable.insertRow();
                const percentage = ((range.count / totalMappings) * 100).toFixed(1);
                row.innerHTML = `
                    <td>${range.confidence_range}</td>
                    <td>${range.count}</td>
                    <td>${percentage}%</td>
                `;
            });

            // Update top performers
            const topPerformersTable = document.getElementById('topPerformersTable');
            topPerformersTable.innerHTML = '';
            data.top_performers.forEach(performer => {
                const row = topPerformersTable.insertRow();
                row.innerHTML = `
                    <td>${performer.source_name}</td>
                    <td>${performer.fantrax_name}</td>
                    <td>${performer.source_system}</td>
                    <td>${performer.usage_count}</td>
                    <td>${(performer.confidence_score || 0).toFixed(1)}%</td>
                    <td>${performer.verified ? '✅ Verified' : '⚠️ Unverified'}</td>
                `;
            });

            // Update problem mappings
            const problemMappingsTable = document.getElementById('problemMappingsTable');
            problemMappingsTable.innerHTML = '';
            data.problem_mappings.forEach(problem => {
                const row = problemMappingsTable.insertRow();
                row.innerHTML = `
                    <td>${problem.source_name}</td>
                    <td>${problem.fantrax_name}</td>
                    <td>${problem.source_system}</td>
                    <td>${(problem.confidence_score || 0).toFixed(1)}%</td>
                    <td>${problem.usage_count}</td>
                `;
            });
        }

        function getHealthIndicator(confidence) {
            if (confidence >= 85) {
                return '<span class="health-indicator health-good">GOOD</span>';
            } else if (confidence >= 70) {
                return '<span class="health-indicator health-warning">WARNING</span>';
            } else {
                return '<span class="health-indicator health-bad">NEEDS REVIEW</span>';
            }
        }

        // Load metrics on page load
        window.onload = function() {
            loadMetrics();
        };

        // Auto-refresh every 5 minutes
        setInterval(loadMetrics, 5 * 60 * 1000);
    </script>
</body>
</html>